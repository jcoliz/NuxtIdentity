# NuxtIdentity.Core.Tests

Unit tests for the NuxtIdentity.Core library.

## Overview

This test project contains Phase 1 happy path tests for the core authentication services:
- [`JwtTokenService<TUser>`](../../src/Core/Services/JwtTokenService.cs) - JWT token generation and validation
- [`InMemoryRefreshTokenService`](../../src/Core/Services/InMemoryRefreshTokenService.cs) - Refresh token management

## Test Coverage

### Current Coverage (Phase 1 - Happy Paths + Error Cases)

```
Overall: 100% line coverage ğŸ¯
         100% branch coverage ğŸ¯

Core Services (Unit Tests):
- InMemoryRefreshTokenService: 100% coverage âœ…
- JwtTokenService<T>: 100% coverage âœ…
- RefreshTokenEntity: 100% coverage âœ…
- JwtOptions: 100% coverage âœ…
```

**Note:** The 0% coverage on model classes (DTOs) is expected - they are simple data transfer objects with no logic to test. Auto-generated logger code is excluded from coverage via ReportGenerator filters.

### Test Count
- **Total Tests:** 28
- **All Passing:** âœ…
- **Latest Addition:** Expired token validation test

### Breakdown by Class

#### JwtTokenServiceTests (14 tests)
Tests use **Gherkin-style comments** (Given/When/Then/And) for improved readability:

**Happy Path Tests:**
- âœ… Token generation returns valid JWT
- âœ… Token contains user claims (NameIdentifier, Name, Email)
- âœ… Token contains standard claims (iat, nbf, issuer, audience)
- âœ… Token expires at correct time
- âœ… Token validation returns ClaimsPrincipal
- âœ… Validated principal contains all claims
- âœ… GetTokenValidationParameters returns correct configuration
- âœ… Multiple users generate unique tokens

**Error Case & Edge Scenario Tests:**
- âœ… Invalid token returns null
- âœ… Expired token returns null
- âœ… Token with wrong signing key returns null
- âœ… User with no name claim uses "unknown" as default
- âœ… Obsolete ExpirationHours property fallback works
- âœ… Multiple claims providers combine all claims

#### InMemoryRefreshTokenServiceTests (14 tests)
Tests use **Gherkin-style comments** (Given/When/Then/And) for improved readability:

- âœ… Token generation returns non-empty token
- âœ… Token generation returns valid Base64 string
- âœ… Multiple calls return unique tokens
- âœ… Valid token validates successfully
- âœ… Non-existent token validation fails
- âœ… Wrong user ID validation fails
- âœ… Revoked token validation fails
- âœ… **Expired token validation fails** â­ NEW
- âœ… Token revocation makes token invalid
- âœ… Revoking non-existent token doesn't throw
- âœ… Revoking all user tokens invalidates all
- âœ… Revocation only affects specific user
- âœ… Revoking for non-existent user doesn't throw
- âœ… Different users' tokens are isolated

### Test Structure Example

All tests follow Gherkin-style comments for clarity:

```csharp
[Test]
public async Task ValidateRefreshTokenAsync_ValidToken_ReturnsTrue()
{
    // Given a valid user ID
    var userId = "user123";
    // And a generated refresh token for that user
    var token = await _service.GenerateRefreshTokenAsync(userId);

    // When validating the token with the correct user ID
    var isValid = await _service.ValidateRefreshTokenAsync(token, userId);

    // Then validation should succeed
    isValid.Should().BeTrue();
}
```

This makes tests more readable and helps understand:
- **Given**: The preconditions and setup
- **When**: The action being tested
- **Then**: The expected outcome
- **And**: Additional context or assertions

## Running Tests

### Run all tests
```bash
dotnet test
```

### Run with detailed output
```bash
dotnet test --logger "console;verbosity=detailed"
```

### Run with coverage (excludes DTOs and auto-generated code)
```bash
dotnet test --settings tests/NuxtIdentity.Core.Tests/coverlet.runsettings --collect:"XPlat Code Coverage" --results-directory ./TestResults
```

### Generate coverage report
```bash
reportgenerator -reports:TestResults/**/coverage.cobertura.xml -targetdir:TestResults/CoverageReport -reporttypes:"Html;TextSummary"
```

### What's Excluded from Coverage

The [`coverlet.runsettings`](coverlet.runsettings) file excludes:
- **Auto-generated code**: Logger methods generated by LoggerMessage source generators
- **DTO Models**: Simple data transfer objects with no business logic
  - ClaimInfo, LoginRequest, LoginResponse, RefreshRequest, RefreshResponse
  - SessionResponse, SignUpRequest, TokenPair, UserInfo

This gives a more accurate picture of actual testable code coverage.

## Test Structure

### Helpers
- [`TestJwtOptions`](Helpers/TestJwtOptions.cs) - Pre-configured JWT settings for tests
- [`TestUser`](Helpers/TestUser.cs) - Simple test user class
- [`TestUserClaimsProvider`](Helpers/TestUserClaimsProvider.cs) - Claims provider for test users

### Test Classes
- [`JwtTokenServiceTests`](Services/JwtTokenServiceTests.cs) - Tests for JWT token service
- [`InMemoryRefreshTokenServiceTests`](Services/InMemoryRefreshTokenServiceTests.cs) - Tests for refresh token service

## Next Steps (Future Phases)

### Phase 1: âœ… **COMPLETE** - 100% Coverage Achieved!

All core services now have complete test coverage including:
- âœ… Happy path scenarios
- âœ… Error cases and edge scenarios
- âœ… Token expiration handling
- âœ… Token tampering detection
- âœ… Invalid configuration handling

### Phase 2 (EF Core Integration)
- Database persistence tests
- Constraint validation
- Transaction handling

### Phase 3 (API Controllers)
- Endpoint integration tests
- Authentication flow tests
- Error response validation

See [`../../plans/testing-strategy.md`](../../plans/testing-strategy.md) for complete strategy.

## Technologies

- **Test Framework:** NUnit 4.3.1
- **Mocking:** Moq 4.20.72
- **Assertions:** FluentAssertions 6.12.1
- **Coverage:** coverlet.collector 6.0.2
